# Results

## Simulated data experiments

1. Simulated data experiments (known disturbance)
  + Single Site, Single Disturbance

Figures showing the current problem, solution, and that we've got a genuine multimodal distribution and P(dist)

  + SSSD Multi Pool

```{r, echo=FALSE,fig.cap="Experiment 2: Assimilation using process-based VSEM captures multi-pool disturbance to leaf and wood biomass"}
load("exp2.Rdata") # Generated by SingleSite_SingleDisturb_MultiPool.Rmd
#Figures showing all 3 pools cov, C accounting / attribution 
pool.names=c("Cleaf","Csoil","Cwood")
for(i in 1:3){
  
  CI.Na = sapply(X = Analysis,function(y){
    x = y$MCMC
    sel.n = which(colnames(x) == paste0("n[",i,"]"))
    quantile(x[,sel.n],c(0.025,0.5,0.975))
  })
  D.Na = sapply(X = Analysis,function(y){
    x = y$MCMC
    sel.n = which(colnames(x) == paste0("D"))
    mean(x[,sel.n])
  })
  
  rng = range(CI.Na)
  if(rng[1]<1) rng[1] = 0
  plot(No[,i],
       ylim = rng,type='n',
       ylab=pool.names[i],xlab="time")
  ecoforecastR::ciEnvelope(1:ncol(CI.Na),CI.Na[1,],CI.Na[3,],col=ecoforecastR::col.alpha('#b2df8a',0.7))
  lines(CI.Na[2,],col="#b2df8a",lwd=2)
  points(No[,i])
  #lines(Ntrue[,i],lty=2,lwd=2)
  #lines(D.Na,lwd=2)
  if(i==1){
    legend("bottomright",legend=c("Assimilation","pseudodata"),
       lwd=5,col=c("#b2df8a","black"))
  }
}
```

```{r,echo=FALSE, fig.asp=1,fig.width=3, fig.cap="Experiment 2: Forecast and Analysis ensembles at the disturbance (t=10). Arrows demonstrate the ensemble adjustment of a sample of 10 ensemble members."}
load("exp2.Rdata")

plot(Analysis[[10]]$Na[,1],Analysis[[10]]$Na[,3],pch="+",col=ecoforecastR::col.alpha("#b2df8a",alpha=1),
     ylim=range(Forecast[[10]]$Nf[,3]),
     xlim=range(Forecast[[10]]$Nf[,1]),
     xlab=pool.names[1],ylab=pool.names[3],
     cex.lab=1.25,asp = 1)
points(Forecast[[10]]$Nf[,1],Forecast[[10]]$Nf[,3],cex=1,col="purple",pch=18)
points(No[10,1],No[10,3],cex=3,col=1)
lines(No[10,1]+c(-1,1)*sqrt(R[1,1]),rep(No[10,3],2))
lines(rep(No[10,1],2),No[10,3]+c(-1,1)*sqrt(R[3,3]))

## ensemble adjustment
ne = nrow(Forecast[[10]]$Nf)
sel.a= seq(1,ne,length=10)#sample.int(ne,10)
arrows(Forecast[[10]]$Nf[sel.a,1],Forecast[[10]]$Nf[sel.a,3],
       Analysis[[10]]$Na[sel.a,1],Analysis[[10]]$Na[sel.a,3],length = 0.1,lwd = 0.5)   
legend("topleft",
       legend=c("Forecast","Analysis","Data"),
       pch=c(1,3,18),col=c("purple","#b2df8a",1),
       cex = 1.5)
```

  
  + SS Multi-Disturbance w/ PFT switching

Figure showing PFT switching vs not, ability to detect disturbance type  

  + Simple Multi-site: spatial cov
  
Figure showing "dragging down" of neighbors in conventional and breaking of COV in Multinomial

```{r, echo=FALSE,fig.cap="Simulated experiments 3-5: Left hand column shows timeseries for the wood pool for all three experiments; Right hand shows bivariate ensemble adjustment at time of disturbance"}
## figure with 3 rows, 2 col showing timeseries in rt and bivariate in left

########experiment 3 - two disturb
load("exp3.Rdata") ## Generated by SingleSite_MultiDisturb_MultiPool.Rmd
pool.names=c("Cleaf","Csoil","Cwood")
i = 3
CI.Na = sapply(X = Analysis,function(y){
  x = y$MCMC
  sel.n = which(colnames(x) == paste0("X[",i,"]"))
  quantile(x[,sel.n],c(0.025,0.5,0.975))
})
rng = range(CI.Na)
if(rng[1]<1) rng[1] = 0
plot(No[,i],
     ylim = rng,type='n',
     ylab=pool.names[i],xlab="time",
     main="Multi-Disturbance")
ecoforecastR::ciEnvelope(1:ncol(CI.Na),CI.Na[1,],CI.Na[3,],col=ecoforecastR::col.alpha('#b2df8a',0.7))
lines(CI.Na[2,],col="#b2df8a",lwd=2)
points(No[,i])
legend("bottomleft",legend=c("Assimilation","pseudodata"),
       lwd=5,col=c("#b2df8a","black"))

plot(Analysis[[10]]$Na[,1],Analysis[[10]]$Na[,3],pch=Analysis[[10]]$Ca,col=ecoforecastR::col.alpha("#b2df8a",alpha=1),
     ylim=range(Forecast[[10]]$Nf[,3]),
     xlim=range(Forecast[[10]]$Nf[,1]),
     xlab=pool.names[1],ylab=pool.names[3],
     cex.lab=1.25,asp = 1)
points(Forecast[[10]]$Nf[,1],Forecast[[10]]$Nf[,3],cex=1,col="purple",pch=18)
points(No[10,1],No[10,3],cex=3,col=1)
lines(No[10,1]+c(-1,1)*sqrt(R[1,1]),rep(No[10,3],2))
lines(rep(No[10,1],2),No[10,3]+c(-1,1)*sqrt(R[3,3]))

## ensemble adjustment
ne = nrow(Forecast[[10]]$Nf)
sel.a= seq(1,ne,length=10)#sample.int(ne,10)
arrows(Forecast[[10]]$Nf[sel.a,1],Forecast[[10]]$Nf[sel.a,3],
       Analysis[[10]]$Na[sel.a,1],Analysis[[10]]$Na[sel.a,3],length = 0.1,lwd = 0.5)   
legend("topleft",
       legend=c("Forecast","Analysis","Data"),
       pch=c(1,3,18),col=c("purple","#b2df8a",1),
       cex = 1.5)

##### experiment 4 - two disturb, pft switch
load("exp4.Rdata") ## SingleSite_MultiDisturb_MultiPool_MultiPFT.Rmd
pool.names=c("Cleaf","Csoil","Cwood")
i = 3
CI.Na = sapply(X = Analysis,function(y){
  x = y$MCMC
  sel.n = which(colnames(x) == paste0("X[",i,"]"))
  quantile(x[,sel.n],c(0.025,0.5,0.975))
})
rng = range(CI.Na)
if(rng[1]<1) rng[1] = 0
plot(No[,i],
     ylim = rng,type='n',
     ylab=pool.names[i],xlab="time",
     main="Multi-Disturbance, PFT switching")
ecoforecastR::ciEnvelope(1:ncol(CI.Na),CI.Na[1,],CI.Na[3,],col=ecoforecastR::col.alpha('#b2df8a',0.7))
lines(CI.Na[2,],col="#b2df8a",lwd=2)
points(No[,i])
legend("bottomleft",legend=c("Assimilation","pseudodata"),
       lwd=5,col=c("#b2df8a","black"))

plot(Analysis[[10]]$Na[,1],Analysis[[10]]$Na[,3],pch=Analysis[[10]]$Ca,col=ecoforecastR::col.alpha("#b2df8a",alpha=1),
     ylim=range(Forecast[[10]]$Nf[,3]),
     xlim=range(Forecast[[10]]$Nf[,1]),
     xlab=pool.names[1],ylab=pool.names[3],
     cex.lab=1.25,asp = 1)
points(Forecast[[10]]$Nf[,1],Forecast[[10]]$Nf[,3],cex=1,col="purple",pch=18)
points(No[10,1],No[10,3],cex=3,col=1)
lines(No[10,1]+c(-1,1)*sqrt(R[1,1]),rep(No[10,3],2))
lines(rep(No[10,1],2),No[10,3]+c(-1,1)*sqrt(R[3,3]))

## ensemble adjustment
ne = nrow(Forecast[[10]]$Nf)
sel.a= seq(1,ne,length=10)#sample.int(ne,10)
arrows(Forecast[[10]]$Nf[sel.a,1],Forecast[[10]]$Nf[sel.a,3],
       Analysis[[10]]$Na[sel.a,1],Analysis[[10]]$Na[sel.a,3],length = 0.1,lwd = 0.5)   
legend("topleft",
       legend=c("Forecast","Analysis","Data"),
       pch=c(1,3,18),col=c("purple","#b2df8a",1),
       cex = 1.5)


######### experiment 5 - one disturb, 2 sites
load("exp5trim.Rdata") ##Generated by TwoSite_SingleDisturb_MultiPool.Rmd
pool.names=c("Cleaf","Csoil","Cwood")
rng = range(CI.Na)
if(rng[1]<1) rng[1] = 0
plot(No[,i],
     ylim = rng,type='n',
     ylab=pool.names[i],xlab="time",
     main="Multi-Site, Single-Disturbance")
  ecoforecastR::ciEnvelope(1:ncol(CI.Na[[3]]),CI.Na[[3]][1,],CI.Na[[3]][3,],col=ecoforecastR::col.alpha('#b2df8a',0.7))
  ecoforecastR::ciEnvelope(1:ncol(CI.Na[[6]]),CI.Na[[6]][1,],CI.Na[[6]][3,],col=ecoforecastR::col.alpha("green",0.7))
lines(CI.Na[[3]][2,],col="#b2df8a",lwd=2)
lines(CI.Na[[6]][2,],col="green",lwd=2)
points(No[,3])
points(No[,6],pch=2)
legend("bottomleft",legend=c("Site 1","Site 2","pseudodata"),
       lwd=5,col=c("#b2df8a","green","black"))

### cov plot
ss = floor(seq(1,nrow(Analysis10$Na),length=200)) ## subsample
plot(Analysis10$Na[,1],Analysis10$Na[,3],pch=Analysis10$Ca,col=ecoforecastR::col.alpha("#b2df8a",alpha=1),
     ylim=range(Forecast10$Nf[,3,1]),
     xlim=range(Forecast10$Nf[,1,1]),
     xlab=pool.names[1],ylab=pool.names[3],
     cex.lab=1.25,asp = 1,type='n')
points(Forecast10$Nf[ss,1,1],Forecast10$Nf[ss,3,1],cex=0.5,col="purple",pch=18)
points(Forecast10$Nf[ss,1,2],Forecast10$Nf[ss,3,2],cex=0.5,col="violet",pch=18)
points(Analysis10$Na[ss,1],Analysis10$Na[ss,3],pch=Analysis10$Ca[ss],col=ecoforecastR::col.alpha("#b2df8a",alpha=0.8),cex=0.5)
points(Analysis10$Na[ss,4],Analysis10$Na[ss,6],pch=Analysis10$Ca[ss],col=ecoforecastR::col.alpha("green",alpha=0.8),cex=0.5)
points(No[10,1],No[10,3],cex=3,col=1)
lines(No[10,1]+c(-1,1)*sqrt(R[1,1]),rep(No[10,3],2))
lines(rep(No[10,1],2),No[10,3]+c(-1,1)*sqrt(R[3,3]))
points(No[10,4],No[10,6],cex=3,col=1)
lines(No[10,4]+c(-1,1)*sqrt(R[1,1]),rep(No[10,6],2))
lines(rep(No[10,4],2),No[10,6]+c(-1,1)*sqrt(R[3,3]))

## ensemble adjustment
sel.a= ss[seq(1,length(ss),length=10)]#sample.int(ne,10)
arrows(Forecast10$Nf[sel.a,1,1],Forecast10$Nf[sel.a,3,1],
       Analysis10$Na[sel.a,1],Analysis10$Na[sel.a,3],length = 0.1,lwd = 0.5)
arrows(Forecast10$Nf[sel.a,1,2],Forecast10$Nf[sel.a,3,2],
       Analysis10$Na[sel.a,4],Analysis10$Na[sel.a,6],length = 0.1,lwd = 0.5)
legend("topleft",
       legend=c("Forecast","Analysis","Data"),
       pch=c(1,3,18),col=c("purple","#b2df8a",1),
       cex = 1)
```


## Remotely-sensed disturbance in Oregon



2. Real-world examples
  + Calibrate state-and-transition prior
    * data: (samples from) maps of disturbance type by year
    * model: Multinomial Dirlichet

Figure showing map and estimated priors
  
  + Applications
    + Logging
    + Fire
    + Land use transition (forest -> non?)
    
* RESULTS
  * needed to reduce obs and process error to work
  * abs magnitude of disturbance is best predictor of assim prob.
    * given magnitude, dist type n.s.