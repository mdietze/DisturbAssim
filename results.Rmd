# Results

## Simulated data experiments

Overall, the results from the simulated data experiments (Table \@ref(tab:pseudoTable)) demonstrate that the proposed multinomial ensemble filter is able to successfully detect disturbances under a range of different conditions. 

Experiment 1, which aimed to capture a single disturbance at a single site for a single pool, was already depicted in Figure \@ref(fig:enkf) and Figure \@ref(fig:concept) when discussing the challenges facing traditional Kalman Filter variants. Specifically, Figure \@ref(fig:enkf) shows that the multinomial filter (blue) is able to capture the discrete nature of the disturbance at time 10, with the posterior probability of disturbance jumping from near zero before this event to 0.977 for the disturbance, and then dropping back down to near zero in subsequent years. Figure \@ref(fig:concept) bottom illustrates what is occurring in this disturbance year. As in the prior 9 years the forecast itself is multimodal, with most of the ensemble members predicting no disturbance and a small number predicting a disturbance event. The multinomial filter assigns a prior mean and variance to each mode based on the ensemble summary statistics, which is the same as a traditional EnKF except for the stratification by disturbance type, and then assigns each state a prior probability based on the ensemble frequency of being in each state (disturbed = dark red, undisturbed = green). When the observed data (red) suggests a large drop in LAI, the posterior (blue) not only updates the ensemble mean and variance of each mode, but also the probability of being in each mode. This posterior is still multimodal, but in this specific instance the weight assigned the undisturbed mode (0.023) is too low to be visually notable. Noteworthy is that the LAI in years 12 and 15 is actually lower than that in the disturbance year but the multinomial, yet the model still assigns this as being undisturbed. This occurs because in these years the observed low LAI is compatible with the observation error around the undisturbed forecast, which has a higher prior probability than the odds of subsequent disturbance.

Experiment 2 expands the assimilation to a multivariate forecast, in this case including joint predictions for leaf, wood, and soil carbon, and with a disturbance to both the leaf and wood pools (Figure \@ref(fig:sssd)). Figure \@ref(fig:sssdBi) shows the multivariate nature of the detection of the disturbance event at time 10, with the bimodal forecast ensemble shown in purple (undisturbed in the top right, disturbed in the bottom left), an observation in black that is consistent with the disturbed state, and the posterior ensemble in green. Arrows depict the adjustment of a random subset of individual ensemble members from the forecast prior to the analysis posterior.

```{r sssd, echo=FALSE,fig.cap="Experiment 2: Assimilation using process-based VSEM captures multi-pool disturbance to leaf and wood biomass"}
load("exp2.Rdata") # Generated by SingleSite_SingleDisturb_MultiPool.Rmd
#Figures showing all 3 pools cov, C accounting / attribution 
pool.names=c("Cleaf","Csoil","Cwood")
for(i in 1:3){
  
  CI.Na = sapply(X = Analysis,function(y){
    x = y$MCMC
    sel.n = which(colnames(x) == paste0("n[",i,"]"))
    quantile(x[,sel.n],c(0.025,0.5,0.975))
  })
  D.Na = sapply(X = Analysis,function(y){
    x = y$MCMC
    sel.n = which(colnames(x) == paste0("D"))
    mean(x[,sel.n])
  })
  
  rng = range(CI.Na)
  if(rng[1]<1) rng[1] = 0
  plot(No[,i],
       ylim = rng,type='n',
       ylab=pool.names[i],xlab="time")
  ecoforecastR::ciEnvelope(1:ncol(CI.Na),CI.Na[1,],CI.Na[3,],col=ecoforecastR::col.alpha('#b2df8a',0.7))
  lines(CI.Na[2,],col="#b2df8a",lwd=2)
  points(No[,i])
  #lines(Ntrue[,i],lty=2,lwd=2)
  #lines(D.Na,lwd=2)
  if(i==1){
    legend("bottomright",legend=c("Assimilation","pseudodata"),
       lwd=5,col=c("#b2df8a","black"))
  }
}
```

```{r sssdBi,echo=FALSE, fig.asp=1,fig.width=3, fig.cap="Experiment 2: Forecast and Analysis ensembles at the disturbance (t=10). Arrows demonstrate the ensemble adjustment of a sample of 10 ensemble members."}
load("exp2.Rdata")

plot(Analysis[[10]]$Na[,1],Analysis[[10]]$Na[,3],pch="+",col=ecoforecastR::col.alpha("#b2df8a",alpha=1),
     ylim=range(Forecast[[10]]$Nf[,3]),
     xlim=range(Forecast[[10]]$Nf[,1]),
     xlab=pool.names[1],ylab=pool.names[3],
     cex.lab=1.25,asp = 1)
points(Forecast[[10]]$Nf[,1],Forecast[[10]]$Nf[,3],cex=1,col="purple",pch=18)
points(No[10,1],No[10,3],cex=3,col=1)
lines(No[10,1]+c(-1,1)*sqrt(R[1,1]),rep(No[10,3],2))
lines(rep(No[10,1],2),No[10,3]+c(-1,1)*sqrt(R[3,3]))

## ensemble adjustment
ne = nrow(Forecast[[10]]$Nf)
sel.a= seq(1,ne,length=10)#sample.int(ne,10)
arrows(Forecast[[10]]$Nf[sel.a,1],Forecast[[10]]$Nf[sel.a,3],
       Analysis[[10]]$Na[sel.a,1],Analysis[[10]]$Na[sel.a,3],length = 0.1,lwd = 0.5)   
legend("topleft",
       legend=c("Forecast","Analysis","Data"),
       pch=c(1,3,18),col=c("purple","#b2df8a",1),
       cex = 1.5)
```

Experiment 3 (Figure \@ref(fig:multiPseudo) top row) illustrates the ability of the multinomial model to select between more than one disturbance. In the bivariate plot (top right panel) we can see that the model can successfully distinguishing between two types of disturbance, one that involves the loss of both wood and leaf biomass (e.g. fire, logging) and the other that just removes leaf biomass (e.g. defoliating forest pest). Experiment 4 (Figure \@ref(fig:multiPseudo) middle row) is similar to 3 but extends the woody biomass removing disturbance to one that causes a switch in PFT from a forest to a low-stature vegetation type (e.g. grassland, shrubland, agriculture), demonstrating that the model can handle land use and land cover changes. Finally, experiment 5 (Figure \@ref(fig:multiPseudo) bottom row) illustrates the extension of the assimilation to multiple sites, one that experiences and disturbance and one that does not. In the years prior to the disturbance the multivariate nature of the assimilation allows us to borrow strength across sites, with observations at one site reducting uncertainty not just at that site but at the other site as well based on the cross-site forecast covariance. That said,this example illustrates the ability of the multinomial model to avoid the impact of spurious correlations across sites during disturbance events. The presence of the disturbance at site 1 did not cause a reduction in biomass in site 2 during the disturbance, nor did it increase the productivity in site 2 in the years post-disturbance despite the large increase observed at site 1.
  
```{r multiPseudo, echo=FALSE,fig.cap="Simulated experiments 3-5: Left hand column shows timeseries for the wood pool for all three experiments; Right hand shows bivariate ensemble adjustment at time of disturbance",fig.height=4,fig.width=3}

## figure with 3 rows, 2 col showing timeseries in rt and bivariate in left
#par(mfrow=c(3,2))
m = matrix(c(1,1,2,3,3,4,5,5,6),nrow=3,byrow = TRUE)
layout(m)

########experiment 3 - two disturb
load("exp3.Rdata") ## Generated by SingleSite_MultiDisturb_MultiPool.Rmd
pool.names=c("Cleaf","Csoil","Cwood")
i = 3
CI.Na = sapply(X = Analysis,function(y){
  x = y$MCMC
  sel.n = which(colnames(x) == paste0("X[",i,"]"))
  quantile(x[,sel.n],c(0.025,0.5,0.975))
})
rng = range(CI.Na)
if(rng[1]<1) rng[1] = 0
plot(No[,i],
     ylim = rng,type='n',
     ylab=pool.names[i],xlab="time",
     main="Multi-Disturbance")
ecoforecastR::ciEnvelope(1:ncol(CI.Na),CI.Na[1,],CI.Na[3,],col=ecoforecastR::col.alpha('#b2df8a',0.7))
lines(CI.Na[2,],col="#b2df8a",lwd=2)
points(No[,i])
legend("bottomleft",legend=c("Assimilation","pseudodata"),
       lwd=5,col=c("#b2df8a","black"))

plot(Analysis[[10]]$Na[,1],Analysis[[10]]$Na[,3],pch=Analysis[[10]]$Ca,col=ecoforecastR::col.alpha("#b2df8a",alpha=1),
     ylim=range(Forecast[[10]]$Nf[,3]),
     xlim=range(Forecast[[10]]$Nf[,1]),
     xlab=pool.names[1],ylab=pool.names[3],
     cex.lab=1.25,asp = 1)
points(Forecast[[10]]$Nf[,1],Forecast[[10]]$Nf[,3],cex=1,col="purple",pch=18)
points(No[10,1],No[10,3],cex=3,col=1)
lines(No[10,1]+c(-1,1)*sqrt(R[1,1]),rep(No[10,3],2))
lines(rep(No[10,1],2),No[10,3]+c(-1,1)*sqrt(R[3,3]))

## ensemble adjustment
ne = nrow(Forecast[[10]]$Nf)
sel.a= seq(1,ne,length=10)#sample.int(ne,10)
arrows(Forecast[[10]]$Nf[sel.a,1],Forecast[[10]]$Nf[sel.a,3],
       Analysis[[10]]$Na[sel.a,1],Analysis[[10]]$Na[sel.a,3],length = 0.1,lwd = 0.5)   
legend("bottomright",
       legend=c("Forecast","Analysis","Data"),
       pch=c(1,3,18),col=c("purple","#b2df8a",1),
       cex = 1.25)

##### experiment 4 - two disturb, pft switch
load("exp4.Rdata") ## SingleSite_MultiDisturb_MultiPool_MultiPFT.Rmd
pool.names=c("Cleaf","Csoil","Cwood")
i = 3
CI.Na = sapply(X = Analysis,function(y){
  x = y$MCMC
  sel.n = which(colnames(x) == paste0("X[",i,"]"))
  quantile(x[,sel.n],c(0.025,0.5,0.975))
})
rng = range(CI.Na)
if(rng[1]<1) rng[1] = 0
plot(No[,i],
     ylim = rng,type='n',
     ylab=pool.names[i],xlab="time",
     main="Multi-Disturbance, PFT switching")
ecoforecastR::ciEnvelope(1:ncol(CI.Na),CI.Na[1,],CI.Na[3,],col=ecoforecastR::col.alpha('#b2df8a',0.7))
lines(CI.Na[2,],col="#b2df8a",lwd=2)
points(No[,i])
legend("bottomleft",legend=c("Assimilation","pseudodata"),
       lwd=5,col=c("#b2df8a","black"))

plot(Analysis[[10]]$Na[,1],Analysis[[10]]$Na[,3],pch=Analysis[[10]]$Ca,col=ecoforecastR::col.alpha("#b2df8a",alpha=1),
     ylim=range(Forecast[[10]]$Nf[,3]),
     xlim=range(Forecast[[10]]$Nf[,1]),
     xlab=pool.names[1],ylab=pool.names[3],
     cex.lab=1.25)
points(Forecast[[10]]$Nf[,1],Forecast[[10]]$Nf[,3],cex=1,col="purple",pch=18)
points(No[10,1],No[10,3],cex=3,col=1)
lines(No[10,1]+c(-1,1)*sqrt(R[1,1]),rep(No[10,3],2))
lines(rep(No[10,1],2),No[10,3]+c(-1,1)*sqrt(R[3,3]))

## ensemble adjustment
ne = nrow(Forecast[[10]]$Nf)
sel.a= seq(1,ne,length=10)#sample.int(ne,10)
arrows(Forecast[[10]]$Nf[sel.a,1],Forecast[[10]]$Nf[sel.a,3],
       Analysis[[10]]$Na[sel.a,1],Analysis[[10]]$Na[sel.a,3],length = 0.1,lwd = 0.5)   
legend("bottomright",
       legend=c("Forecast","Analysis","Data"),
       pch=c(1,3,18),col=c("purple","#b2df8a",1),
       cex = 1.25)


######### experiment 5 - one disturb, 2 sites
load("exp5trim.Rdata") ##Generated by TwoSite_SingleDisturb_MultiPool.Rmd
pool.names=c("Cleaf","Csoil","Cwood")
rng = range(CI.Na)
if(rng[1]<1) rng[1] = 0
plot(No[,i],
     ylim = rng,type='n',
     ylab=pool.names[i],xlab="time",
     main="Multi-Site, Single-Disturbance")
  ecoforecastR::ciEnvelope(1:ncol(CI.Na[[3]]),CI.Na[[3]][1,],CI.Na[[3]][3,],col=ecoforecastR::col.alpha('#b2df8a',0.7))
  ecoforecastR::ciEnvelope(1:ncol(CI.Na[[6]]),CI.Na[[6]][1,],CI.Na[[6]][3,],col=ecoforecastR::col.alpha("green",0.7))
lines(CI.Na[[3]][2,],col="#b2df8a",lwd=2)
lines(CI.Na[[6]][2,],col="green",lwd=2)
points(No[,3])
points(No[,6],pch=2)
legend("bottomleft",legend=c("Site 1","Site 2","pseudodata"),
       lwd=5,col=c("#b2df8a","green","black"))

### cov plot
ss = floor(seq(1,nrow(Analysis10$Na),length=200)) ## subsample
plot(Analysis10$Na[,1],Analysis10$Na[,3],pch=Analysis10$Ca,col=ecoforecastR::col.alpha("#b2df8a",alpha=1),
     ylim=range(Forecast10$Nf[,3,1]),
     xlim=range(Forecast10$Nf[,1,1]),
     xlab=pool.names[1],ylab=pool.names[3],
     cex.lab=1.25,asp = 1,type='n')
points(Forecast10$Nf[ss,1,1],Forecast10$Nf[ss,3,1],cex=0.5,col="purple",pch=18)
points(Forecast10$Nf[ss,1,2],Forecast10$Nf[ss,3,2],cex=0.5,col="violet",pch=18)
points(Analysis10$Na[ss,1],Analysis10$Na[ss,3],pch=Analysis10$Ca[ss],col=ecoforecastR::col.alpha("#b2df8a",alpha=0.8),cex=0.5)
points(Analysis10$Na[ss,4],Analysis10$Na[ss,6],pch=Analysis10$Ca[ss],col=ecoforecastR::col.alpha("green",alpha=0.8),cex=0.5)
points(No[10,1],No[10,3],cex=3,col=1)
lines(No[10,1]+c(-1,1)*sqrt(R[1,1]),rep(No[10,3],2))
lines(rep(No[10,1],2),No[10,3]+c(-1,1)*sqrt(R[3,3]))
points(No[10,4],No[10,6],cex=3,col=1)
lines(No[10,4]+c(-1,1)*sqrt(R[1,1]),rep(No[10,6],2))
lines(rep(No[10,4],2),No[10,6]+c(-1,1)*sqrt(R[3,3]))

## ensemble adjustment
sel.a= ss[seq(1,length(ss),length=10)]#sample.int(ne,10)
arrows(Forecast10$Nf[sel.a,1,1],Forecast10$Nf[sel.a,3,1],
       Analysis10$Na[sel.a,1],Analysis10$Na[sel.a,3],length = 0.1,lwd = 0.5)
arrows(Forecast10$Nf[sel.a,1,2],Forecast10$Nf[sel.a,3,2],
       Analysis10$Na[sel.a,4],Analysis10$Na[sel.a,6],length = 0.1,lwd = 0.5)
legend("topleft",
       legend=c("Forecast","Analysis","Data"),
       pch=c(1,3,18),col=c("purple","#b2df8a",1),
       cex = 1)
```

## VSEM Calibration



## Remotely-sensed disturbance in Oregon

```{r ORorig, echo=FALSE}
## summary figure showing didn't work great at default error rate

### Row 1: Example time-series ###
site = 188
exp.name = c("P1Q1R1","P1Q1R4")
exp.pretty.name = c("Original","Low Obs Error")
pool.names=c("Cleaf","Csoil","AGB")
i = 3 ## Stem
for(ex in seq_along(exp.name)){
  load(paste0("OR_TS_",site,"_",exp.name[ex],".RData"))
  plot(Yi[,i],
       ylim = range(rbind(CI.Na,Yi[,i],CI.D),na.rm=TRUE),
       type='n',
       ylab=pool.names[i],xlab="time",
       main=exp.pretty.name[ex])
  ecoforecastR::ciEnvelope(1:ncol(CI.Na),CI.Na[1,],CI.Na[5,],col=ecoforecastR::col.alpha('#b2df8a',0.7))
  lines(CI.Na[3,],col="#b2df8a",lwd=2)
  points(Yi[,i])
  if(ex == 1) {
    legend("bottomleft",legend=c("Assimilation","Data"),
       lwd=5,col=c("#b2df8a","black"),cex=0.7)
  }
}

### Row 2: Divergence ###
load("stats.RData")
load("elist.RData")
disturb.names = c("Intact","Other","Cut","Fire","Pest")
disturb.col = c("#ebebeb",'#b04c00','#1f78b4','#faabaa','#b2df8a')
disturb.col.al <- tapply(disturb.col,1:5,FUN=ecoforecastR::col.alpha,0.7); disturb.col.al[1] = disturb.col[1]
for(i in 1:2){
  ## divergence
  div = (elist[[i]]$divergence[,1] - obs.tlo)/
    (apply(elist[[i]]$divergence[,c(2,6)],1,diff)*0.5)
  div.reg    = lm(div~obs.tlo)
  
  dh = density(na.omit(div))
#  abline(v=c(-1,1),lty=2)
  plot(obs.tlo,div,col=disturb.col.al[obs.class],
       xlab="final AGB",ylab="Divergence",
       pch=16)
  abline(h=c(-1,1),lty=2)
  abline(div.reg,col="purple",lwd=3)
  abline(v=0,lty=2)
  lines(dh$y*10,dh$x,lwd=3)
  if(i == 1) legend("topright",legend=disturb.names,
                  col=disturb.col,pch=16,cex=0.7,
                  text.col=c(1,disturb.col[2:5]))
}


### Row 3: Disturbance magnitude vs P(detection) ###
pred.seq=list()
distabs = obs.pre-obs.dist
pred.seq$distabs = seq(min(distabs),max(distabs),length=500)
for(i in 1:2){
  distrate = distrate = elist[[i]]$distrate
  dist.qb.abs = glm(distrate ~ distabs,
                    na.action=na.omit,
                    family=quasibinomial("logit")
  )
  plot(distabs,distrate,col=disturb.col.al[obs.class],
       xlab="AGB disturbance magnitude",ylab="P(detect)",
       pch=16)
  lines(pred.seq$distabs,predict(dist.qb.abs,newdata=pred.seq,type="response"),col="purple")
  if(i == 1) legend("topleft",legend=disturb.names,
                  col=disturb.col,pch=16,cex=0.7,
                  text.col=c(1,disturb.col[2:5]))
}
```

    
* RESULTS
  * limited success under default parameters
    * high frequency of filter divergence [summary fig, example divergence fig]
    * divergence coverage original `r stats[[1]]$div.cov`
    * divergence coverage low error `r stats[[2]]$div.cov`
    * the smaller the observed biomass at the end of the timeseries, the larger the divergence [include scatterplot?]
    * low rate of detected disturbance [calc stat?, hist? cdf?]
    * what disturbances were detected tended to be associated with high pre-disturbance biomass and a large reduction in biomass (both absolute and proportional). Most commonly seen in dist class "red"
  * needed to reduce obs and process error to work
  * example "successful" scenario: P1Q1R4
    * reduced observation error
    * abs magnitude of disturbance is best predictor of assim prob. [fig]
      * given magnitude, dist type n.s.  
  * comparative analysis
    
    
    
    
    
