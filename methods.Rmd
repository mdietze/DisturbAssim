# Methods

## VSEM (Very Simple Ecosystem Model)

To illustrate the problem of assimilating disturbance, and present potential solutions, we make use of the Very Simple Ecosystem Model (VSEM), a daily-timestep point-scale model developed by David Cameron that is available in the BayesianTools R package [@BayesianTools]. VSEM contains three carbon pools, leaf (Cl), wood (Cw), and soil (Cs), and calculates leaf area index based on specific leaf area (SLA), $LAI = SLA*Cl$. Gross Primary Productivity (GPP) is estimated based on incoming photosynthetically active radiation (PAR), light use efficiency (LUE), and Beer's Law light interception ($1-exp(-K_{ext}\cdot LAI)$) with a extinction coefficient $K_{ext}$. Autotrophic respiration, Ra, is a fixed fraction, $\Gamma$ of GPP. Of the remaining carbon (net primary productivity), a fixed fraction, $Av$, is allocated to leaves and the remainder is allocated to wood. Leaves and wood turnover into soil C based on fixed longevities, $\tau_l$ and $\tau_w$, while heterotrophic respiration, Rh, occurs based on a fixed residence time $\tau_s$. Net Ecosystem Exchange follows the atmospheric sign convention $Ra + Rh - GPP$. The VSEM was selected for its speed and ease of understanding, but its fundamental structure is analogous to much more complex, large-scale terrestrial carbon models. 

## Ensemble Adjustment Kalman Filter

To 

1. Illustration of problem

## Derivation of Multinomial Filter

*Priors*

  $$X^L_k \sim MVN(\vec{\mu}_{f,k},P_{f,k})$$
  $$\vec{\rho} \sim Multinomial(1,\vec{p})$$ 
*Process Model*

  $$X = X^L \vec{\rho}$$
  
*Likelihood*
  $$Y \sim MVN(X,R)$$
### Ensemble Adjustment

[@Anderson2001]

*reassignment of classes*

To reassign forecasted ensemble members to new disturbance classes we first identify those that decreased between the prior probability, $p_k$, and the posterior frequency, $\bar{\rho}_k$.

$$\delta p_k = max\{0,\bar{\rho}_k-p_k \}$$

Classes that decreased in relative abundance are reassigned to new classes according to a Multinomial draw

$$c_{A|k} = Multinomial\left( n_k, {{\delta p}\over{\sum \delta p}}  \right)$$ 


Conceptual figure


## Class-based Ensemble adjustment


## VSEM Description


## Simulated data experiments


3. Simulated data experiments (known disturbance)
  + describe model
  + x Single Site, Single Disturbance  (add a case where EnKF has disturb but it's more rare)
  + x SSSD Multi Pool
  + x SS Multi-Disturbance - distinct
  + x SS Multi-Disturbance w/ distinct, PFT switching
      * mention parallel PFT ensembles
      * need to protect against long-term PFT leakage; related to more general need to "look back"
  + x Simple Multi-site: spatial cov
  + SSMD - initially overlapping but diverge
      * how to handle updating of assignment based on new information?
  + SSMD - transition probabilities change with state
  + rate of false pos/neg: affected by p.dist, R, Q, P0 -- how much do we need to simulate?
4. Real-world examples
  + Calibrate state-and-transition prior
    + Landtrendr
    http://emapr.ceoas.oregonstate.edu/pages/data/viz/index.html
    + Location:
    tile h03v04
xmin       : -2115585 
xmax       : -1965585 
ymin       : 2564805 
ymax       : 2714805 
Upper Left  (-2115585.000, 2714805.000) (123d 6'32.29"W, 44d41'17.09"N)
Lower Left  (-2115585.000, 2564805.000) (122d35' 7.51"W, 43d23'46.18"N)
Upper Right (-1965585.000, 2714805.000) (121d16'45.91"W, 45d 3'17.45"N)
Lower Right (-1965585.000, 2564805.000) (120d47'15.95"W, 43d45'18.18"N)
Center      (-2040585.000, 2639805.000) (121d56'25.42"W, 44d13'35.07"N)
> res(cover)
[1] 30 30
> crs(cover)
CRS arguments:
 +proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +datum=NAD83
+units=m +no_defs 
    + Biomass [@Kennedy2018]
      1990-2017
    + Cover
      1990-2017
    + Disturbance
      1984-2011
      - nearest neighbor resampled to same as cover
    + LAI??
  + Calibrate model
  + Applications: PNW
    + Logging
    + Fire
    + Land use transition (forest -> non?)

Email to Robert:

I need to extract some example time series for single pixels (e.g. AGB product) where the disturbance it is far enough in the past that there’s an interesting recovery trajectory but also where it’s not so early (so that the data assimilation has time to come into steady-state before the disturbance). From Landtrendr itself I’m looking to know when you attributed the year, severity, and cause so we can see if our assimilation is getting it “right”. Bonus would be if you could suggest places where you know there’s ground data we could use to validate the model (disturbances at flux towers, LTER sites, FIA plots, etc).


Things to try:
* Run just the Assimilation step for simulated disturbance that vary in magnitude, process error, observation error, etc to detect sensitivity
* Approximation of not simulating disturbed ensemble members and relying SOLEY on ensemble adjustment
* Analytical approximation of sequential beta-binomial then KF vs full joint model

## Calibration of VSEM
* 

[@BayesianTools]


## Comparison to real-world data

* LandTrendr tile
* Construction of frequency and transition matrix priors


